// choc3d.min.js - Mathieu Ledru
'use strict';var Choc3D=Choc3D||{VERSION:"1.0"};Choc3D.App=function(){this.renderer=new THREE.WebGLRenderer;this.scene=new Choc3D.Choc3DScene;this.camera=new THREE.PerspectiveCamera;this.light=new THREE.PointLight(16777215);this.camera.position.x=2;this.camera.position.y=1;this.camera.position.z=2;this.scene.add(this.camera);this.light.position.copy(this.camera.position);this.scene.add(this.light)};
Choc3D.App.prototype={constructor:Choc3D.App,reshape:function(a,b){this.camera.projectionMatrix.makePerspective(45,a/b,0.1,1E4);this.renderer.setSize(a,b)},render:function(){this.renderer.render(this.scene,this.camera)},update:function(a){this.scene.update(a)}};Choc3D.Object=function(a){THREE.Object3D.call(this);this.weight=0;this.velocity=new THREE.Vector3(0,0,0);this.add(a)};Choc3D.Object.prototype=Object.create(THREE.Object3D.prototype);
Choc3D.Ball=function(a,b){a=a||new THREE.SphereGeometry(0.5,16,16);b=b||new THREE.MeshPhongMaterial({color:16777215*Math.random()});Choc3D.Object.call(this,new THREE.Mesh(a,b));this.radius=0.5};Choc3D.Ball.prototype=Object.create(Choc3D.Object.prototype);Choc3D.Plane=function(a,b){a=a||new THREE.PlaneGeometry(1,1);b=b||new THREE.MeshPhongMaterial({color:16777215*Math.random()});Choc3D.Object.call(this,new THREE.Mesh(a,b));this.normal=this.up.clone()};Choc3D.Plane.prototype=Object.create(Choc3D.Object.prototype);
Choc3D.Plane.prototype.lookAt=function(a){Choc3D.Object.prototype.lookAt.call(this,a);this.normal.sub(a,this.position).normalize()};Choc3D.Physics=function(){this.ZERO=Math.pow(2,-32);this.objects=[]};
Choc3D.Physics.prototype={constructor:Choc3D.Physics,add:function(a){a instanceof Choc3D.Object&&this.objects.push(a)},remove:function(a){a=this.objects.indexOf(a);-1!==a&&this.objects.splice(a,1)},update:function(a){for(var b=this.objects.length,c,g,d,f,e;0<a;){var h=a,i=null;for(c=0;c<b;c++)for(g=c+1;g<b;g++){d=this.objects[c];f=this.objects[g];e=void 0;if(d instanceof Choc3D.Ball&&f instanceof Choc3D.Ball)e=this.timeCollisionBallBall(d,f);else if(d instanceof Choc3D.Ball&&f instanceof Choc3D.Plane||
d instanceof Choc3D.Plane&&f instanceof Choc3D.Ball)e=this.timeCollisionBallPlane(d instanceof Choc3D.Ball?d:f,d instanceof Choc3D.Plane?d:f);void 0!==e&&(0<=e&&e<h)&&(h=e,i={i:c,j:g})}for(c=0;c<b;c++)g=this.objects[c],d=g.velocity.clone().multiplyScalar(h),g.position.addSelf(d);if(i)if(d=this.objects[i.i],f=this.objects[i.j],d instanceof Choc3D.Ball&&f instanceof Choc3D.Ball)this.collideBallBall(d,f);else if(d instanceof Choc3D.Ball&&f instanceof Choc3D.Plane||d instanceof Choc3D.Plane&&f instanceof
Choc3D.Ball)this.collideBallPlane(d instanceof Choc3D.Ball?d:f,d instanceof Choc3D.Plane?d:f);a-=h}},timeCollisionBallBall:function(a,b){var c=new THREE.Vector3;c.sub(b.position,a.position);var g=new THREE.Vector3;g.sub(b.velocity,a.velocity);var d=g.clone().multiplySelf(g),f=c.clone().multiplySelf(g),g=d.x+d.y+d.z,e=2*(f.x*f.y+f.x*f.z+f.y*f.z)+g*Math.pow(a.radius+b.radius,2),e=e-Math.pow(c.x,2)*(d.y+d.z),e=e-Math.pow(c.y,2)*(d.x+d.z),e=e-Math.pow(c.z,2)*(d.x+d.y);if(!(0>e)&&(e=Math.sqrt(e),d=-(f.x+
f.y+f.z),c=void 0,f=d+e,0<=f&&(c=f),e=d-e,0<=e&&c>e&&(c=e),void 0!==c))return c/=g,c-=c*this.ZERO},timeCollisionBallPlane:function(a,b){var c=a.velocity.dot(b.normal);if(!(-this.ZERO<c)){var g=new THREE.Vector3;g.sub(a.position,b.normal.clone().multiplyScalar(a.radius));var d=new THREE.Vector3;d.sub(b.position,g);return b.normal.dot(d)/c}},collideBallBall:function(a,b){var c=new THREE.Vector3;c.sub(a.velocity,b.velocity);var g=new THREE.Vector3;g.sub(a.position,b.position).normalize();c=2/(1/a.weight+
1/b.weight)*g.dot(c);a.velocity.sub(a.velocity,g.clone().multiplyScalar(c/a.weight));b.velocity.add(b.velocity,g.clone().multiplyScalar(c/b.weight))},collideBallPlane:function(a,b){var c=2*a.velocity.dot(b.normal),g=b.normal.clone();a.velocity.sub(a.velocity,g.multiplyScalar(c))}};
Choc3D.Choc3DScene=function(){function a(a,d,c){var e;if("x"===a&&"y"===d||"y"===a&&"x"===d)e="z";else if("x"===a&&"z"===d||"z"===a&&"x"===d)e="y";else if("z"===a&&"y"===d||"y"===a&&"z"===d)e="x";var h=new Choc3D.Plane;h.position[a]=0;h.position[d]=0;h.position[e]=0.5*c;h.lookAt(new THREE.Vector3(0,0,0));b.add(h)}THREE.Scene.call(this);this.physics=new Choc3D.Physics;var b=this;a("z","y",1);a("z","y",-1);a("x","z",1);a("x","z",-1);a("x","y",1);a("x","y",-1);for(var c=0;10>c;++c)this.addBall()};
Choc3D.Choc3DScene.prototype=Object.create(THREE.Scene.prototype);
Choc3D.Choc3DScene.prototype.addBall=function(){var a=function(a){var b=new THREE.Vector3,c=new THREE.Vector3(1,1,1),e=new THREE.Box3;e.setFromCenterAndSize(b,c);var h=new THREE.Box3;h.setFromCenterAndSize(a.position,c.clone().multiplyScalar(2*a.radius));if(!e.containsBox(h))return!1;c=0;for(e=this.children.length;c<e;c++)if(h=this.children[c],h instanceof Choc3D.Ball&&(b.sub(a.position,h.position),b.lengthSq()<=Math.pow(a.radius+h.radius,2)+this.physics.ZERO))return!1;return!0},b=new Choc3D.Ball,
c=b.radius;do b.position.x=Math.random()-0.5,b.position.y=Math.random()-0.5,b.position.z=Math.random()-0.5,b.velocity.x=(Math.random()-0.5)/1E3,b.velocity.y=(Math.random()-0.5)/1E3,b.velocity.z=(Math.random()-0.5)/1E3,b.radius=Math.random()/25+0.05,b.weight=2*(4*Math.PI*Math.pow(b.radius,3)/3);while(!a.call(this,b));b.scale.multiplyScalar(b.radius/c);this.add(b)};Choc3D.Choc3DScene.prototype.add=function(a){THREE.Scene.prototype.add.call(this,a);this.physics.add(a)};
Choc3D.Choc3DScene.prototype.remove=function(a){this.physics.remove(a);THREE.Scene.prototype.remove.call(this,a)};Choc3D.Choc3DScene.prototype.update=function(a){this.physics.update(a)};
